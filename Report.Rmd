---
title: 'Your Title Here'
author: "Maggie Walsh"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
csl: bioinformatics.csl
bibliography: references.bib
params:
  gff_file_path: "data/metadata/sars_refgenome_annotation.gff"
  vcf_dir_path: "data/11_vcf_output_for_R"
  sra_runtable_path: "data/00_sra_runtable/SraRunTable_NY_fixed.txt"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = TRUE)
```

# Background and Overview

This is a report on SARS-CoV-2, including some variant analysis [@koyama2020variant].

# Methods

See the set of tutorials on the [vcfR package website](https://knausb.github.io/vcfR_documentation/index.html).

You may also want to use any of a range of different COVID data packages and data sources:

* https://kjhealy.github.io/covdata/
* https://github.com/como-ph/oxcovid19
* https://ropensci.org/blog/2020/10/20/searching-medrxivr-and-biorxiv-preprint-data/
* https://covidtracking.com/data/api
  * `readr::read_csv("https://api.covidtracking.com/v1/states/daily.csv")`

## Subsections are ok too

# Results and Discussion

```{r load-packages-and-functions}
library("vcfR")
library("ggplot2")
library("dplyr")
library("ggthemes")
library("COVID19")
library("gghighlight")

# this loads all function files in the code/functions directory
function_paths <- list.files("code/functions", full.names = TRUE)
purrr::walk(function_paths, source)
```

```{r load-vcf-data}
# load in, tidy, and stack all of the VCF files in the target directory
# these are the output of the bash pipeline
stacked_vcfs <- parse_tidy_and_stack_vcfs(
  vcf_dir_path = params$vcf_dir_path)

# load in the gff file with genome annotations for SARS-CoV-2
gff <- read_gff(gff_file_path = params$gff_file_path)

# pull out just the named genes from the annotation file
gene_table <- extract_genes_from_gff(annotation_object = gff)

# combine the stacked vcf table with the gene names and the metadata from
# the sra runtable file
vcf_with_metadata <- add_genes_metadata_to_vcfstack(
  sra_runtable_path = params$sra_runtable_path,
  stacked_vcf = stacked_vcfs,
  cleaned_genes_table = gene_table)
```

# Figures

```{r sample-plot}
# create a plot of unique SNP locations within each gene across all samples
vcf_with_metadata %>%
  filter(!is.na(gene)) %>% # get rid of SNPs not in gene regions
  group_by(gene, pos) %>%
  tally() %>% # this gives a column n for the number of gene by position
  group_by(gene) %>%
  tally() %>% # this collapses that down to the number of unique SNP locations
  ggplot(aes(x = gene,
             y = n)) +
    geom_col() +
    labs(title = "Count of distinct SNPs in Named SARS-CoV-2 Genes",
         x = "Gene Name") +
  theme_few() # get rid of the grey background
```

**Figure 1**: N and S genes have more unique SNPs in the set of samples analyzed.

```{r Covid-Data}
#trying to use COVID19 package to look at data regarding New York city
# first get all covid data from period of interest
covid_data_broad <- COVID19::covid19(country = "USA",
                                  level = 2,
                                  start = "2020-02-01",
                                  end = "2021-04-28")

# make a plot summarizing covid cases by state during this time
covid_plot <- covid_data_broad %>%
  ggplot(aes(date, confirmed)) +
  geom_line(aes(group = administrative_area_level_2)) +
  gghighlight(administrative_area_level_2 == "New York") +
  labs(title = "Number of Confirmed SARS-CoV-2 Cases by State",
       x = "Date", y = "Confirned Cases") +
  theme_clean()

covid_plot

```
***Figure 1***: Plot of confirmed SARS-CoV-2 cases in the past year. New York state was the hardest hit early on in the pandemic having a majority of the nations confirmed cases. The steep rise in cases was contained in subsequent months. In recent winter months, New York, alongside other states, has again seen a steep rise in cases.


```{r NY-Data}
# get specific covid data
covid_data_specific <- COVID19::covid19(country = "USA",
                                  level = 3,
                                  start = "2020-03-01",
                                  end = "2021-04-28")

# filter out NY data
NY_covid_data <- covid_data_specific %>%
  filter(administrative_area_level_3 == "New York City")

# Make plot of cases in NY
NY_covid_data_plot <- NY_covid_data %>%
  ggplot(aes(date, confirmed)) +
         geom_line() +
  labs(title = "Number of Confirmed Covid Cases in New York City",
       y = "Confirmed Cases", x = "Date") +
  geom_vline(xintercept = as.numeric(as.Date("2020-03-20")),
             linetype = "dashed",
             color = "green") +
  theme_clean()
  
NY_covid_data_plot

```
***Figure 2***

```{r NY-zoomed-in}
# get specific covid data thats zoomed in on specific period
covid_data_specific_zoom <- COVID19::covid19(country = "USA",
                                  level = 3,
                                  start = "2020-03-01",
                                  end = "2020-04-10")

NY_covid_data_zoom <- covid_data_specific_zoom %>%
  filter(administrative_area_level_3 == "New York City")

# Make plot of cases in NY
NY_covid_data_zoom_plot <- NY_covid_data_zoom %>%
  ggplot(aes(date, confirmed)) +
         geom_line() +
  labs(title = "Number of Confirmed Covid Cases in New York City",
       y = "Confirmed Cases", x = "Date") +
  geom_vline(xintercept = as.numeric(as.Date("2020-03-20")),
             linetype = "dashed",
             color = "green") +
  theme_clean()
  
NY_covid_data_zoom_plot
```

```{r NY-mobility-data}
# look at mobility data to get an idea of what mobility was like in NYC
covid_data_NY_mobility <- COVID19::covid19(country = "USA",
                              level = 3,
                              start = "2020-03-01",
                              end = "2020-04-10",
                              gmr =  paste0("https://www.gstatic.com/covid19/",
                                           "mobility/",
                                           "Global_Mobility_Report.csv"))

# filter NYC data
NY_covid_data_mobility <- covid_data_NY_mobility %>%
  filter(administrative_area_level_3 == "New York City")

#Plot
NY_covid_data_mobility_plot <- NY_covid_data_mobility %>%
  ggplot(aes(date, transit_stations_percent_change_from_baseline)) +
  geom_bar(stat = "identity") +
  labs(title = "Bar Plot of Transit Mobility in New York City",
       x = "Date",
       y = "Percent Change from Baseline at Transit Stations") +
  theme_clean()

NY_covid_data_mobility_plot

```
***Figure 4*** Bar plot showing percent change in mobility at transit stations in New York, from a baseline set before the pandemic. 
# Tables

```{r example-table}
# An example table to show the length of each gene using its start and end
gene_table %>%
  mutate(length = end - start) %>%
  select(gene_name, start, end, length) %>%
  knitr::kable(col.names = c("Gene Name",
                             "Start",
                             "End",
                             "Length"))
```

**Table 1**: Gene names, locations, and lengths in the SARS-CoV-2 genome. Higher SNP counts in the S and N genes may be related to the larger size of these genes.

# Sources Cited
